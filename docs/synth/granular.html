<head>
  <link href="../favicon.ico" rel="shortcut icon" type="image/x-icon"/>
  <link href="../style.css" rel="stylesheet"/>
  <title>BQN Musician: Granular synthesis</title>
</head>
<div class="nav">(<a href="https://github.com/mlochbaum/BQN-musician">github</a>) / <a href="../index.html">BQN Musician</a> / <a href="index.html">synth</a></div>
<h1 id="granular-synthesis"><a class="header" href="#granular-synthesis">Granular synthesis</a></h1>
<p>The concept of granular synthesis is to compose a sound from very short &quot;grains&quot; that exactly or almost repeat. Generally this is done by cutting out bits of a sample, and while this can lead to very <a href="https://www.youtube.com/watch?v=CKxXJAXFnvg">cool effects</a>, it's more of a sound processing method than synthesis. But it's also possible to use purely synthesized sectionsâ€”while this doesn't usually go by the name &quot;granular&quot;, I'm using it here as an organizing principle.</p>
<p>The methods here will create a sequence of grains each with length <code><span class='Value'>g</span></code> and string them together to get a sound with frequency <code><span class='Value'>rate</span> <span class='Function'>Ã·</span> <span class='Value'>g</span></code>. At a low-to-medium frequency, a grain contains hundreds of samples, so generating each as an array can make this a good fit for array programming. The simplest thing to try is to keep the grain constant. That's just an <a href="oscillator.html">oscillator</a> with a specified shape, so it's nothing new, but at least we'll see the mechanics of assembling grains. Here's a sawtooth wave, created granular-style.</p>
<a class="replLink" title="Open in the REPL" target="_blank" href="https://mlochbaum.github.io/BQN/try.html#code=cmF0ZSDihpAgNDQxMDAKQ2VudGVyIOKGkCB7KDLDl/CdlakpLTF9CkdyYWluU2F3IOKGkCB7IGxlbiDwnZWKIGY6CiAgZyDihpAg4oyKMC41ICsgcmF0ZSDDtyBmICAgICMgTGVuZ3RoIG9mIGEgZ3JhaW4KICBuIOKGkCDijIhsZW4gw7cgZyAgICAgICAgICAgIyBOdW1iZXIgb2YgZ3JhaW5zCiAgZ3JhaW4g4oaQIENlbnRlciAo4oaVZynDt2cgICMgT25lIGdyYWluCiAg4oi+IG4g4qWKIDwgZ3JhaW4gICAgICAgICAgIyBSZXBlYXRlZCBhcyBuZWNlc3NhcnkKfQrigKJQbGF5IHJhdGUgR3JhaW5TYXcgMjIwICAgIyBBMyBmb3IgMSBzZWNvbmQ=">â†—ï¸</a><pre>    <span class='Value'>rate</span> <span class='Gets'>â†</span> <span class='Number'>44100</span>
    <span class='Function'>Center</span> <span class='Gets'>â†</span> <span class='Brace'>{</span><span class='Paren'>(</span><span class='Number'>2</span><span class='Function'>Ã—</span><span class='Value'>ğ•©</span><span class='Paren'>)</span><span class='Function'>-</span><span class='Number'>1</span><span class='Brace'>}</span>
    <span class='Function'>GrainSaw</span> <span class='Gets'>â†</span> <span class='Brace'>{</span> <span class='Value'>len</span> <span class='Function'>ğ•Š</span> <span class='Value'>f</span><span class='Head'>:</span>
      <span class='Value'>g</span> <span class='Gets'>â†</span> <span class='Function'>âŒŠ</span><span class='Number'>0.5</span> <span class='Function'>+</span> <span class='Value'>rate</span> <span class='Function'>Ã·</span> <span class='Value'>f</span>    <span class='Comment'># Length of a grain
</span>      <span class='Value'>n</span> <span class='Gets'>â†</span> <span class='Function'>âŒˆ</span><span class='Value'>len</span> <span class='Function'>Ã·</span> <span class='Value'>g</span>           <span class='Comment'># Number of grains
</span>      <span class='Value'>grain</span> <span class='Gets'>â†</span> <span class='Function'>Center</span> <span class='Paren'>(</span><span class='Function'>â†•</span><span class='Value'>g</span><span class='Paren'>)</span><span class='Function'>Ã·</span><span class='Value'>g</span>  <span class='Comment'># One grain
</span>      <span class='Function'>âˆ¾</span> <span class='Value'>n</span> <span class='Function'>â¥Š</span> <span class='Function'>&lt;</span> <span class='Value'>grain</span>          <span class='Comment'># Repeated as necessary
</span>    <span class='Brace'>}</span>
    <span class='Function'>Play</span> <span class='Value'>rate</span> <span class='Function'>GrainSaw</span> <span class='Number'>220</span>   <span class='Comment'># A3 for 1 second
</span><audio src="audio_granular/a0.mp3" controls></audio>
</pre>
<p>The arguments to <code><span class='Function'>GrainSaw</span></code> are the total length needed, <code><span class='Value'>len</span></code>, and the frequency, <code><span class='Value'>f</span></code>. The frequency is rounded here to get a whole number for the grain size <code><span class='Value'>g</span></code>. For example the requested frequency of 220Hz is rounded to 220.5, a difference too small to hear in most situations. Higher frequencies can round a lot more, but such small grains aren't as interesting to work with anyway, so I'd probably stick with lower frequencies.</p>
<a class="replLink" title="Open in the REPL" target="_blank" href="https://mlochbaum.github.io/BQN/try.html#code=cmF0ZSDihpAgNDQxMDAKcmF0ZSDDtyDijIogMC41ICsgcmF0ZcO3MjIwICAgIyBPZmYgYnkgNCBjZW50cwoKcmF0ZSDDtyDijIogMC41ICsgcmF0ZcO3MTgwMCAgIyBBIHdvcnNlIGNhc2U6IDM1IGNlbnRz">â†—ï¸</a><pre>    <span class='Value'>rate</span> <span class='Function'>Ã·</span> <span class='Function'>âŒŠ</span> <span class='Number'>0.5</span> <span class='Function'>+</span> <span class='Value'>rate</span><span class='Function'>Ã·</span><span class='Number'>220</span>   <span class='Comment'># Off by 4 cents
</span>220.5

    <span class='Value'>rate</span> <span class='Function'>Ã·</span> <span class='Function'>âŒŠ</span> <span class='Number'>0.5</span> <span class='Function'>+</span> <span class='Value'>rate</span><span class='Function'>Ã·</span><span class='Number'>1800</span>  <span class='Comment'># A worse case: 35 cents
</span>1764
</pre>
<p>For another try at a granular method, we might start with a sine wave at a much lower frequency than our eventual grain size, and move along it: each grain starts one sample later in that wave. This is exactly the <a href="https://mlochbaum.github.io/BQN/doc/windows.html">Windows</a> (<code><span class='Function'>â†•</span></code>) primitive. Now we do get a changing timbre, if a harsh one!</p>
<a class="replLink" title="Open in the REPL" target="_blank" href="https://mlochbaum.github.io/BQN/try.html#code=4oCiUGxheSDipYogNDAwIOKGlSDigKJtYXRoLlNpbiAxNMO3y5zihpU2MDA=">â†—ï¸</a><pre>    <span class='Function'>Play</span> <span class='Function'>â¥Š</span> <span class='Number'>400</span> <span class='Function'>â†•</span> <span class='Value'>â€¢math.</span><span class='Function'>Sin</span> <span class='Number'>14</span><span class='Function'>Ã·</span><span class='Modifier'>Ëœ</span><span class='Function'>â†•</span><span class='Number'>600</span>
<audio src="audio_granular/a1.mp3" controls></audio>
</pre>
<p>The grain size doesn't have to stay constant, although a fixed size may be easier to work with. For example <a href="https://mlochbaum.github.io/BQN/doc/prefixes.html">Prefixes</a> (<code><span class='Function'>â†‘</span></code>) gives us an increasing size and thus a falling frequency. Here <a href="https://mlochbaum.github.io/BQN/doc/join.html#join">Join</a> (<code><span class='Function'>âˆ¾</span></code>) is essential to combine the differently-sized grains.</p>
<a class="replLink" title="Open in the REPL" target="_blank" href="https://mlochbaum.github.io/BQN/try.html#code=4oCiUGxheSDiiL4g4oaRIOKAom1hdGguU2luIDE0w7fLnOKGlTUwMA==">â†—ï¸</a><pre>    <span class='Function'>Play</span> <span class='Function'>âˆ¾</span> <span class='Function'>â†‘</span> <span class='Value'>â€¢math.</span><span class='Function'>Sin</span> <span class='Number'>14</span><span class='Function'>Ã·</span><span class='Modifier'>Ëœ</span><span class='Function'>â†•</span><span class='Number'>500</span>
<audio src="audio_granular/a2.mp3" controls></audio>
</pre>
<h2 id="karplus-strong-pluck-simulation"><a class="header" href="#karplus-strong-pluck-simulation">Karplus-Strong pluck simulation</a></h2>
<p>The <a href="https://en.wikipedia.org/wiki/Karplus%E2%80%93Strong_string_synthesis">Karplus-Strong</a> method is usually expressed as continuously updating a cyclic buffer. But it can also be done by replacing the entire buffer at once, at the cost of getting one input too far in the future. This can be fixed but it's a bit ugly; also the future value hardly differs from the current one and I don't think it makes an audible difference.</p>
<p>What we'll do is to start with a random grainâ€”white noise is traditional but I think it sounds pretty bad so I'll drop in a pink noise generator hereâ€”and update it to be quieter and gentler on each iteration. This mimics the way that higher harmonics die off faster when a string is plucked. Here we average each sample with one next to it, and multiply by a constant that's a little less than 1 to damp the value a little more. It's not the only iteration that can be done but it's one of the simplest.</p>
<a class="replLink" title="Open in the REPL" target="_blank" href="https://mlochbaum.github.io/BQN/try.html#code=cmF0ZSDihpAgNDQxMDAKUmFuZCDihpAg4oCicmFuZC5SYW5nZQpQaW5rIOKGkCB7w7fin5wo4oyIwrR8KSArYCDwnZWpIOKGkSDipYriiJjijYniiJjiiY3CtOKMvSAt4p+cwqviiJhSYW5k4p+cMMKoICgx4oyI4oaV4oiY4oyIKeKMvigy4ouG4oG84oqiKTLijIjwnZWpfQoKUGx1Y2sg4oaQIHsg8J2ViiBm4oC/bGVu4oC/YXR0OiAjIEZyZXF1ZW5jeSwgbGVuZ3RoLCBhdHRlbnVhdGlvbgogIGcg4oaQIOKMijAuNStyYXRlw7dmCiAgbiDihpAg4oyIbGVuw7dnCiAgdCDihpAgMiDii4YgLWF0dMO3ZyAgIyBDb25zdGFudCBmb3IgYXR0ZW51YXRpb24KICBsZW4g4oaRIOKIviB7dCDDlyAo8J2VqSsx4oy98J2VqSnDtzJ94o2fKOKGlW4pIFBpbmsgZwp9CuKAolBsYXkgUGx1Y2sgMTQ34oC/cmF0ZeKAvzEw">â†—ï¸</a><pre>    <span class='Function'>Rand</span> <span class='Gets'>â†</span> <span class='Value'>â€¢rand.</span><span class='Function'>Range</span>
    <span class='Function'>Pink</span> <span class='Gets'>â†</span> <span class='Brace'>{</span><span class='Function'>Ã·</span><span class='Modifier2'>âŸœ</span><span class='Paren'>(</span><span class='Function'>âŒˆ</span><span class='Modifier'>Â´</span><span class='Function'>|</span><span class='Paren'>)</span> <span class='Function'>+</span><span class='Modifier'>`</span> <span class='Value'>ğ•©</span> <span class='Function'>â†‘</span> <span class='Function'>â¥Š</span><span class='Modifier2'>âˆ˜</span><span class='Function'>â‰</span><span class='Modifier2'>âˆ˜</span><span class='Function'>â‰</span><span class='Modifier'>Â´</span><span class='Function'>âŒ½</span> <span class='Function'>-</span><span class='Modifier2'>âŸœ</span><span class='Function'>Â«</span><span class='Modifier2'>âˆ˜</span><span class='Function'>Rand</span><span class='Modifier2'>âŸœ</span><span class='Number'>0</span><span class='Modifier'>Â¨</span> <span class='Paren'>(</span><span class='Number'>1</span><span class='Function'>âŒˆâ†•</span><span class='Modifier2'>âˆ˜</span><span class='Function'>âŒˆ</span><span class='Paren'>)</span><span class='Modifier2'>âŒ¾</span><span class='Paren'>(</span><span class='Number'>2</span><span class='Function'>â‹†</span><span class='Modifier'>â¼</span><span class='Function'>âŠ¢</span><span class='Paren'>)</span><span class='Number'>2</span><span class='Function'>âŒˆ</span><span class='Value'>ğ•©</span><span class='Brace'>}</span>

    <span class='Function'>Pluck</span> <span class='Gets'>â†</span> <span class='Brace'>{</span> <span class='Function'>ğ•Š</span> <span class='Value'>f</span><span class='Ligature'>â€¿</span><span class='Value'>len</span><span class='Ligature'>â€¿</span><span class='Value'>att</span><span class='Head'>:</span> <span class='Comment'># Frequency, length, attenuation
</span>      <span class='Value'>g</span> <span class='Gets'>â†</span> <span class='Function'>âŒŠ</span><span class='Number'>0.5</span><span class='Function'>+</span><span class='Value'>rate</span><span class='Function'>Ã·</span><span class='Value'>f</span>
      <span class='Value'>n</span> <span class='Gets'>â†</span> <span class='Function'>âŒˆ</span><span class='Value'>len</span><span class='Function'>Ã·</span><span class='Value'>g</span>
      <span class='Value'>t</span> <span class='Gets'>â†</span> <span class='Number'>2</span> <span class='Function'>â‹†</span> <span class='Function'>-</span><span class='Value'>att</span><span class='Function'>Ã·</span><span class='Value'>g</span>  <span class='Comment'># Constant for attenuation
</span>      <span class='Value'>len</span> <span class='Function'>â†‘</span> <span class='Function'>âˆ¾</span> <span class='Brace'>{</span><span class='Value'>t</span> <span class='Function'>Ã—</span> <span class='Paren'>(</span><span class='Value'>ğ•©</span><span class='Function'>+</span><span class='Number'>1</span><span class='Function'>âŒ½</span><span class='Value'>ğ•©</span><span class='Paren'>)</span><span class='Function'>Ã·</span><span class='Number'>2</span><span class='Brace'>}</span><span class='Modifier2'>âŸ</span><span class='Paren'>(</span><span class='Function'>â†•</span><span class='Value'>n</span><span class='Paren'>)</span> <span class='Function'>Pink</span> <span class='Value'>g</span>
    <span class='Brace'>}</span>
    <span class='Function'>Play</span> <span class='Function'>Pluck</span> <span class='Number'>147</span><span class='Ligature'>â€¿</span><span class='Value'>rate</span><span class='Ligature'>â€¿</span><span class='Number'>10</span>
<audio src="audio_granular/a3.mp3" controls></audio>
</pre>
<p>The structure is very similar to <code><span class='Function'>GrainSaw</span></code> from above. The one major difference is the way we generate <code><span class='Value'>n</span></code> grains. Each grain is produced from the one before with <code><span class='Brace'>{</span><span class='Value'>t</span> <span class='Function'>Ã—</span> <span class='Paren'>(</span><span class='Value'>ğ•©</span><span class='Function'>+</span><span class='Number'>1</span><span class='Function'>âŒ½</span><span class='Value'>ğ•©</span><span class='Paren'>)</span><span class='Function'>Ã·</span><span class='Number'>2</span><span class='Brace'>}</span></code>, which uses <a href="https://mlochbaum.github.io/BQN/doc/reverse.html#rotate">Rotate</a> (<code><span class='Function'>âŒ½</span></code>) as shown below. To get them all, we want the initial grain, then one filtered once, twice, three times, and so on. The tool for this is <a href="https://mlochbaum.github.io/BQN/doc/repeat.html">Repeat</a> (<code><span class='Modifier2'>âŸ</span></code>) with an array right operand (0, 1, 2, 3â€¦). Repeat saves its intermediate results, so this takes linear time even though doing each number separately would be quadratic.</p>
<a class="replLink" title="Open in the REPL" target="_blank" href="https://mlochbaum.github.io/BQN/try.html#code=ZXgg4oaQIDHigL8w4oC/MOKAvzXigL8wCjEg4oy9IGV4Cgp78J2VqSsx4oy98J2VqX0gZXgKCnso8J2VqSsx4oy98J2VqSnDtzJ9IGV4ICAjIFNtb290aGVkIG91dCBhIGxpdHRsZSE=">â†—ï¸</a><pre>    <span class='Value'>ex</span> <span class='Gets'>â†</span> <span class='Number'>1</span><span class='Ligature'>â€¿</span><span class='Number'>0</span><span class='Ligature'>â€¿</span><span class='Number'>0</span><span class='Ligature'>â€¿</span><span class='Number'>5</span><span class='Ligature'>â€¿</span><span class='Number'>0</span>
    <span class='Number'>1</span> <span class='Function'>âŒ½</span> <span class='Value'>ex</span>
âŸ¨ 0 0 5 0 1 âŸ©

    <span class='Brace'>{</span><span class='Value'>ğ•©</span><span class='Function'>+</span><span class='Number'>1</span><span class='Function'>âŒ½</span><span class='Value'>ğ•©</span><span class='Brace'>}</span> <span class='Value'>ex</span>
âŸ¨ 1 0 5 5 1 âŸ©

    <span class='Brace'>{</span><span class='Paren'>(</span><span class='Value'>ğ•©</span><span class='Function'>+</span><span class='Number'>1</span><span class='Function'>âŒ½</span><span class='Value'>ğ•©</span><span class='Paren'>)</span><span class='Function'>Ã·</span><span class='Number'>2</span><span class='Brace'>}</span> <span class='Value'>ex</span>  <span class='Comment'># Smoothed out a little!
</span>âŸ¨ 0.5 0 2.5 2.5 0.5 âŸ©
</pre>
<h2 id="scanned-synthesis"><a class="header" href="#scanned-synthesis">Scanned synthesis</a></h2>
<p>What if we make our grain into an oscillator, in the sense that it obeys force laws? We'll start simple: we can make a sine-ish wave by using a grain of one sample. To do this, we track the position <em>and velocity</em> at each step, because our oscillator needs to have some momentum that keeps it going in the same direction. To make a step, we add a multiple of the velocity to the position, and subtract a multiple of the position from the velocity, to represent a force that pushes back towards position 0. Since the scaling of the velocity doesn't matter, I'll use the same multiple for both updates, just with different signs. To get the sound, we update many times, then take only the positions with <code><span class='Function'>âŠ‘</span><span class='Modifier'>Â¨</span></code>.</p>
<a class="replLink" title="Open in the REPL" target="_blank" href="https://mlochbaum.github.io/BQN/try.html#code=cmF0ZSDihpAgNDQxMDAK4ouI4p+cLSAwLjA0ICAjIENvZWZmaWNpZW50cyB0byB1c2UKCnvwnZWpKyjii4jin5wtMC4wNCnDl+KMvfCdlal9IDHigL81CgrigKJQbGF5IDAuMDEgw5cg4oqRwqgge/CdlakrKOKLiOKfnC0wLjA0KcOX4oy98J2VqX3ijZ8o4oaVcmF0ZSkgMeKAvzAgICMgTG91ZCE=">â†—ï¸</a><pre>    <span class='Function'>â‹ˆ</span><span class='Modifier2'>âŸœ</span><span class='Function'>-</span> <span class='Number'>0.04</span>  <span class='Comment'># Coefficients to use
</span>âŸ¨ 0.04 Â¯0.04 âŸ©

    <span class='Brace'>{</span><span class='Value'>ğ•©</span><span class='Function'>+</span><span class='Paren'>(</span><span class='Function'>â‹ˆ</span><span class='Modifier2'>âŸœ</span><span class='Function'>-</span><span class='Number'>0.04</span><span class='Paren'>)</span><span class='Function'>Ã—âŒ½</span><span class='Value'>ğ•©</span><span class='Brace'>}</span> <span class='Number'>1</span><span class='Ligature'>â€¿</span><span class='Number'>5</span>
âŸ¨ 1.2 4.96 âŸ©

    <span class='Function'>Play</span> <span class='Number'>0.01</span> <span class='Function'>Ã—</span> <span class='Function'>âŠ‘</span><span class='Modifier'>Â¨</span> <span class='Brace'>{</span><span class='Value'>ğ•©</span><span class='Function'>+</span><span class='Paren'>(</span><span class='Function'>â‹ˆ</span><span class='Modifier2'>âŸœ</span><span class='Function'>-</span><span class='Number'>0.04</span><span class='Paren'>)</span><span class='Function'>Ã—âŒ½</span><span class='Value'>ğ•©</span><span class='Brace'>}</span><span class='Modifier2'>âŸ</span><span class='Paren'>(</span><span class='Function'>â†•</span><span class='Value'>rate</span><span class='Paren'>)</span> <span class='Number'>1</span><span class='Ligature'>â€¿</span><span class='Number'>0</span>  <span class='Comment'># Loud!
</span><audio src="audio_granular/a4.mp3" controls></audio>
</pre>
<p>This gets out of control very quickly, because the changes are discrete instead of continuousâ€”the position and velocity should trace out a circle, but they turn late, and spiral outwards instead. I've multiplied by <code><span class='Number'>0.01</span></code> and it still clips almost immediately. To fix this, I can multiply by a number slightly less than 1 at every step. And by dampling just a little more than I have to, I get a nice exponential <a href="envelope.html#decay">decay</a> instead.</p>
<a class="replLink" title="Open in the REPL" target="_blank" href="https://mlochbaum.github.io/BQN/try.html#code=cmF0ZSDihpAgNDQxMDAK4oCiUGxheSDiipHCqCB7KDEtOWXCrzQpw5fwnZWpKyjii4jin5wtMC4wNCnDl+KMvfCdlal94o2fKOKGlXJhdGUpIDHigL8w">â†—ï¸</a><pre>    <span class='Function'>Play</span> <span class='Function'>âŠ‘</span><span class='Modifier'>Â¨</span> <span class='Brace'>{</span><span class='Paren'>(</span><span class='Number'>1</span><span class='Function'>-</span><span class='Number'>9eÂ¯4</span><span class='Paren'>)</span><span class='Function'>Ã—</span><span class='Value'>ğ•©</span><span class='Function'>+</span><span class='Paren'>(</span><span class='Function'>â‹ˆ</span><span class='Modifier2'>âŸœ</span><span class='Function'>-</span><span class='Number'>0.04</span><span class='Paren'>)</span><span class='Function'>Ã—âŒ½</span><span class='Value'>ğ•©</span><span class='Brace'>}</span><span class='Modifier2'>âŸ</span><span class='Paren'>(</span><span class='Function'>â†•</span><span class='Value'>rate</span><span class='Paren'>)</span> <span class='Number'>1</span><span class='Ligature'>â€¿</span><span class='Number'>0</span>
<audio src="audio_granular/a5.mp3" controls></audio>
</pre>
<p>This a rather inefficient way to make a sine wave, but it's a starting point for a neat method called <a href="https://csound.com/docs/manual/SiggenScanTop.html">scanned synthesis</a>. First, if we make <code><span class='Value'>ğ•©</span></code> a shape <code><span class='Number'>2</span><span class='Ligature'>â€¿</span><span class='Value'>g</span></code> array, we get something that sounds more complex. The frequency is determined by the grain size, <code><span class='Number'>200</span></code> here, and the volume oscillates because that's what oscillators do.</p>
<a class="replLink" title="Open in the REPL" target="_blank" href="https://mlochbaum.github.io/BQN/try.html#code=UmFuZCDihpAg4oCicmFuZC5SYW5nZQpQaW5rIOKGkCB7w7fin5wo4oyIwrR8KSArYCDwnZWpIOKGkSDipYriiJjijYniiJjiiY3CtOKMvSAt4p+cwqviiJhSYW5k4p+cMMKoICgx4oyI4oaV4oiY4oyIKeKMvigy4ouG4oG84oqiKTLijIjwnZWpfQrigKJQbGF5IOKIviDiio/CqCB7KDEtOWXCrzQpw5fwnZWpKyjii4jin5wtMC4wNCnDl+KMvfCdlal94o2fKOKGlTQwMCkge/CdlaniiY0wwqjwnZWpfSBQaW5rIDIwMA==">â†—ï¸</a><pre>    <span class='Function'>Play</span> <span class='Function'>âˆ¾</span> <span class='Function'>âŠ</span><span class='Modifier'>Â¨</span> <span class='Brace'>{</span><span class='Paren'>(</span><span class='Number'>1</span><span class='Function'>-</span><span class='Number'>9eÂ¯4</span><span class='Paren'>)</span><span class='Function'>Ã—</span><span class='Value'>ğ•©</span><span class='Function'>+</span><span class='Paren'>(</span><span class='Function'>â‹ˆ</span><span class='Modifier2'>âŸœ</span><span class='Function'>-</span><span class='Number'>0.04</span><span class='Paren'>)</span><span class='Function'>Ã—âŒ½</span><span class='Value'>ğ•©</span><span class='Brace'>}</span><span class='Modifier2'>âŸ</span><span class='Paren'>(</span><span class='Function'>â†•</span><span class='Number'>400</span><span class='Paren'>)</span> <span class='Brace'>{</span><span class='Value'>ğ•©</span><span class='Function'>â‰</span><span class='Number'>0</span><span class='Modifier'>Â¨</span><span class='Value'>ğ•©</span><span class='Brace'>}</span> <span class='Function'>Pink</span> <span class='Number'>200</span>
<audio src="audio_granular/a6.mp3" controls></audio>
</pre>
<p>In scanned synthesis the different components should interact with each other instead of oscillating independently. The physical idea here is that there's some sort of slowly wobbling springy sheet, and a scanner that cycles around it measuring. We get the scanner just by joining grains together, and for the interaction we'll include components based on the two samples next to the one we're updating. The function <code><span class='Function'>Force</span></code> gets the direction the current sample is being pushed: slightly towards zero, which is <code><span class='Number'>0.1</span><span class='Function'>Ã—</span><span class='Number'>0</span><span class='Function'>-</span><span class='Value'>ğ•©</span></code>, and strongly towards the values on the left <code><span class='Paren'>(</span><span class='Number'>Â¯1</span><span class='Function'>âŒ½</span><span class='Value'>ğ•©</span><span class='Paren'>)</span><span class='Function'>-</span><span class='Value'>ğ•©</span></code> and right <code><span class='Paren'>(</span><span class='Number'>1</span><span class='Function'>âŒ½</span><span class='Value'>ğ•©</span><span class='Paren'>)</span><span class='Function'>-</span><span class='Value'>ğ•©</span></code>. Adding these together gives a total force. It's applied to the position with <a href="https://mlochbaum.github.io/BQN/doc/under.html">Under</a> First Cell, <code><span class='Modifier2'>âŒ¾</span><span class='Function'>âŠ</span></code> before the reverse which causes it to be added to the velocities.</p>
<a class="replLink" title="Open in the REPL" target="_blank" href="https://mlochbaum.github.io/BQN/try.html#code=cmF0ZSDihpAgNDQxMDAKUmFuZCDihpAg4oCicmFuZC5SYW5nZQpQaW5rIOKGkCB7w7fin5wo4oyIwrR8KSArYCDwnZWpIOKGkSDipYriiJjijYniiJjiiY3CtOKMvSAt4p+cwqviiJhSYW5k4p+cMMKoICgx4oyI4oaV4oiY4oyIKeKMvigy4ouG4oG84oqiKTLijIjwnZWpfQpTY2FuU3ludGgg4oaQIHsgbGVuIPCdlYogZjoKICBnIOKGkCDijIowLjUrcmF0ZcO3ZgogIG4g4oaQIOKMiGxlbsO3ZwogIEZvcmNlIOKGkCB7KMKvMeKMvfCdlakpKygx4oy98J2VqSkgLSAyLjHDl/Cdlal9CiAgVXBkYXRlIOKGkCB78J2VqSArIDRlwq8zIMOXIOKMvSBGb3JjZeKMvuKKjyDwnZWpfQogIGxlbiDihpEg4oi+IOKKj8KoIFVwZGF0ZeKNnyjihpVuKSBbUGluayBnLCBn4qWKMF0KfQrigKJQbGF5IDAuMyDDlyAoMTDDl3JhdGUpIFNjYW5TeW50aCAxNDc=">â†—ï¸</a><pre>    <span class='Function'>ScanSynth</span> <span class='Gets'>â†</span> <span class='Brace'>{</span> <span class='Value'>len</span> <span class='Function'>ğ•Š</span> <span class='Value'>f</span><span class='Head'>:</span>
      <span class='Value'>g</span> <span class='Gets'>â†</span> <span class='Function'>âŒŠ</span><span class='Number'>0.5</span><span class='Function'>+</span><span class='Value'>rate</span><span class='Function'>Ã·</span><span class='Value'>f</span>
      <span class='Value'>n</span> <span class='Gets'>â†</span> <span class='Function'>âŒˆ</span><span class='Value'>len</span><span class='Function'>Ã·</span><span class='Value'>g</span>
      <span class='Function'>Force</span> <span class='Gets'>â†</span> <span class='Brace'>{</span><span class='Paren'>(</span><span class='Number'>Â¯1</span><span class='Function'>âŒ½</span><span class='Value'>ğ•©</span><span class='Paren'>)</span><span class='Function'>+</span><span class='Paren'>(</span><span class='Number'>1</span><span class='Function'>âŒ½</span><span class='Value'>ğ•©</span><span class='Paren'>)</span> <span class='Function'>-</span> <span class='Number'>2.1</span><span class='Function'>Ã—</span><span class='Value'>ğ•©</span><span class='Brace'>}</span>
      <span class='Function'>Update</span> <span class='Gets'>â†</span> <span class='Brace'>{</span><span class='Value'>ğ•©</span> <span class='Function'>+</span> <span class='Number'>4eÂ¯3</span> <span class='Function'>Ã—</span> <span class='Function'>âŒ½</span> <span class='Function'>Force</span><span class='Modifier2'>âŒ¾</span><span class='Function'>âŠ</span> <span class='Value'>ğ•©</span><span class='Brace'>}</span>
      <span class='Value'>len</span> <span class='Function'>â†‘</span> <span class='Function'>âˆ¾</span> <span class='Function'>âŠ</span><span class='Modifier'>Â¨</span> <span class='Function'>Update</span><span class='Modifier2'>âŸ</span><span class='Paren'>(</span><span class='Function'>â†•</span><span class='Value'>n</span><span class='Paren'>)</span> <span class='Bracket'>[</span><span class='Function'>Pink</span> <span class='Value'>g</span><span class='Separator'>,</span> <span class='Value'>g</span><span class='Function'>â¥Š</span><span class='Number'>0</span><span class='Bracket'>]</span>
    <span class='Brace'>}</span>
    <span class='Function'>Play</span> <span class='Number'>0.3</span> <span class='Function'>Ã—</span> <span class='Paren'>(</span><span class='Number'>10</span><span class='Function'>Ã—</span><span class='Value'>rate</span><span class='Paren'>)</span> <span class='Function'>ScanSynth</span> <span class='Number'>147</span>
<audio src="audio_granular/a7.mp3" controls></audio>
</pre>
<p>Now we get something with a complex changing tone over time! The overall frequency is still determined by the grain size <code><span class='Value'>g</span></code>, but as the samples push each other around, the grain shape changes, changing the timbre with it.</p>
